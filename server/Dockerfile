FROM golang:1.23

WORKDIR /app

COPY go.mod go.sum ./
RUN go mod download

COPY . .

# Server Config
ENV DEBUG=${DEBUG}
ENV ALLOWED_HOSTS=${ALLOWED_HOSTS}
ENV SERVER_HOST=${SERVER_HOST}
ENV SERVER_PORT=${SERVER_PORT}

# Database Config
ENV MASTER_DB_INSTANCE_CONNECTION_NAME=${MASTER_DB_INSTANCE_CONNECTION_NAME}
ENV MASTER_DB_NAME=${MASTER_DB_NAME}
ENV MASTER_DB_USER=${MASTER_DB_USER}
ENV MASTER_DB_PASSWORD=${MASTER_DB_PASSWORD}
ENV MASTER_DB_HOST=${MASTER_DB_HOST}
ENV MASTER_DB_PORT=${MASTER_DB_PORT}
ENV MASTER_DB_LOG_MODE=${MASTER_DB_LOG_MODE}
ENV MASTER_DB_SSL_MODE=${MASTER_DB_SSL_MODE}

# Redis Config
ENV REDIS_HOST=${REDIS_HOST}
ENV REDIS_PORT=${REDIS_PORT}
ENV REDIS_PASSWORD=${REDIS_PASSWORD}

# Auth Config
ENV API_JWT_SECRET_KEY=${API_JWT_SECRET_KEY}
ENV API_JWT_EXPIRY=${API_JWT_EXPIRY}
ENV API_ADMIN_KEY=${API_ADMIN_KEY}

RUN make build

EXPOSE 3000

CMD ["make", "run"]